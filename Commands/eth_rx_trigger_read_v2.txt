-- Generate External Trigger from Ethernet Commands
------------------------------------------------------------------------------------------------------------------------------------------------------------------
    -- Generate an external trigger using ethernet commands (One letter or symbol from the keyboard).
    -- Use the letter 't' in Lowercase to generate an external trigger for DAPHNE V1.
    -- This external trigger is generated by constantly checking the first byte of the payload sent by the ethernet frame.
    -- This uses a clocked process that depends on the WR_CLK of the FIFO, specifically on its falling edge in order to guarantee
    -- That "the center" of the Data will be sampled by the rising edge of the clock, avoiding possible misalignments.
    -- If the data equals the letter 't', it asks if it was seen in the cycle before that in order to generate only a pulse with 
    -- A width of one CLK Cycle, if it matches this case, the trigger happens, else it stays off    
    ETH_TRIG_PROC : process(afe_se_clk, async_rst, eth_com_rx_payload, eth_com_rx_payload_reg)
        begin
            if falling_edge(afe_se_clk) then
                if (async_rst = '1') then
                    eth_trig_reg <= '0';
                else
                    -- Assign the value to a register to keep track fo the last payload given to the FPGA
                    eth_com_rx_payload_reg <= eth_com_rx_payload;
                    
                    -- Let's see if the data has changed
                    if (eth_com_rx_payload /= eth_com_rx_payload_reg) then
                        -- The data has changed, therefore it is time to see if the payload condition to trigger is met
                        if (eth_com_rx_payload = X"74") then
                            -- If the payload condition is met, generate a trigger
                            eth_trig_reg <= '1';
                        else
                            -- Do not generate a trigger
                            eth_trig_reg <= '0';
                        end if;
                    else
                        -- Do not generate a trigger
                        eth_trig_reg <= '0';
                    end if;
                end if;    
            end if;
    end process ETH_TRIG_PROC;
    
    -- External Triggers OR Gate Control
    ext_trig                <= eth_trig_reg; -- OR gpi;
    
    -- Generate External Read from Ethernet Commands
------------------------------------------------------------------------------------------------------------------------------------------------------------------
    -- Creates a signal to read the FIFO externally by using the keys on the keyboard.
    -- Specifically use the letter 'r'.
    -- Exactly the same behaviour as the external trigger generation
    ETH_READ_PROC : process(afe_se_clk, async_rst, eth_com_rx_payload, eth_com_rx_payload_reg)
        begin
            if falling_edge(afe_se_clk) then
                if (async_rst = '1') then
                    eth_read_reg <= '0';
                else
                    -- Assign the value to a register to keep track fo the last payload given to the FPGA
                    eth_com_rx_payload_reg <= eth_com_rx_payload;
                    
                    -- Let's see if the data has changed
                    if (eth_com_rx_payload /= eth_com_rx_payload_reg) then
                        -- The data has changed, therefore it is time to see if the payload condition to trigger is met
                        if (eth_com_rx_payload = X"72") then
                            -- If the payload condition is met, generate a trigger
                            eth_read_reg <= '1';
                        else
                            -- Do not generate a trigger
                            eth_read_reg <= '0';
                        end if;
                    else
                        -- Do not generate a trigger
                        eth_read_reg <= '0';
                    end if;
                end if;    
            end if;
    end process ETH_READ_PROC;
    
    -- External Triggers OR Gate Control
    ext_read                <= eth_read_reg; 